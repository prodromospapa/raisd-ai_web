{% extends 'base.html' %}
{% block content %}
  <div class="card" style="display:flex;gap:18px;align-items:center;">
    <div style="flex:0 0 auto;">
      <div aria-hidden="true" style="width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,160,220,0.06),rgba(0,120,200,0.03));border:1px solid rgba(0,140,200,0.08);">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="9" stroke="rgba(0,150,220,0.12)" stroke-width="3"></circle>
          <path d="M21 12a9 9 0 0 0-9-9" stroke="#00A6E6" stroke-width="3" stroke-linecap="round">
            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite" />
          </path>
        </svg>
      </div>
    </div>
    <div style="flex:1;min-width:0;">
      <h2 style="margin:0 0 6px 0;">Processing your analysis</h2>
      <div id="shortStatus" style="font-size:15px;font-weight:600;color:var(--muted);">Preparing analysis</div>
      <div id="subStatus" style="margin-top:6px;color:var(--muted);font-size:13px;">This page updates automatically — results will appear here when ready.</div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
        <div style="flex:1;min-width:0;">
          <div style="height:10px;background:var(--muted);border-radius:999px;overflow:hidden;position:relative;border:1px solid var(--border);">
            <div id="indeterminateBar" style="position:absolute;left:-30%;width:30%;height:100%;background:linear-gradient(90deg, rgba(0,170,240,0.18), rgba(0,170,240,0.36));border-radius:999px;animation:indet 1.6s linear infinite;"></div>
          </div>
          
        </div>
        <div style="flex:0 0 auto;text-align:right;">
          <div style="height:1px;">&nbsp;</div>
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
            <button id="cancelRun" class="btn" title="Cancel this run">Cancel run</button>
            <button id="toggleLogs" class="btn" title="Show logs">Show logs</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div style="margin-top:12px;">
    <div class="log-preview" id="logPreview" style="display:none;">
      <div style="flex:1;">
        <div style="font-size:13px;font-weight:600;margin-bottom:6px;color:var(--muted);">Recent logs</div>
        <div id="logPane" class="log-pane">Waiting for logs…</div>
        <div class="log-controls">
          <!-- log controls removed: open folder and clear buttons intentionally omitted -->
        </div>
      </div>
    </div>
  </div>

  <span id="proc-meta" data-run-id="{{ run_id }}" hidden></span>
{% endblock %}
{% block scripts %}
<script>
(function(){
  const m = document.getElementById('proc-meta');
  const runId = m ? m.getAttribute('data-run-id') : '';
  let pollTimer = null;
  let redirecting = false;
  let userToggledLogs = false;

  const short = document.getElementById('shortStatus');
  const sub = document.getElementById('subStatus');

  function prettyStatusFromTail(tailJson){
    // Try to infer a short friendly status from available fields.
    // Priority: RAiSD_Info.results existence (server picks), then run.log hints, then generic states.
    if(!tailJson) return {title: 'Initializing', subtitle: 'Preparing analysis environment'};
    if(tailJson.done) return {title: 'Finalizing', subtitle: 'Rendering results and plots'};
    // If RAiSD stdout/stderr contain specific phrases, map them to friendlier text
    const out = (tailJson.raisd_stdout || '').toLowerCase();
    const err = (tailJson.raisd_stderr || '').toLowerCase();
    const lines = (tailJson.lines || '').toLowerCase();
    if(/index|indexing/.test(lines) || /index|indexing/.test(out)) return {title: 'Indexing input', subtitle: 'Creating or validating variant indices (fast)'};
    if(/reading|scan|scanning|scanned/.test(lines) || /scan|reading/.test(out)) return {title: 'Scanning variants', subtitle: 'Reading variant records and computing allele counts'};
    if(/window|grid|computing grid/.test(lines) || /computing/.test(out)) return {title: 'Computing grid', subtitle: 'Building analysis grid and scoring windows'};
    if(/writing|output|saving/.test(lines) || /writing/.test(out)) return {title: 'Writing output', subtitle: 'Saving report files to disk'};
    if(/error|traceback/.test(err) || /error/.test(lines)) return {title: 'Problem detected', subtitle: 'An error occurred — check run details after completion'};
    if(lines && lines.length > 80) return {title: 'Running analysis', subtitle: 'Working through samples — this may take a while'};
    return {title: 'Running', subtitle: 'Starting RAiSD analysis'};
  }

  function setStatus(title, subtitle){ if(short) short.textContent = title || ''; if(sub) sub.textContent = subtitle || ''; }

  function pollOnce(){
    fetch(`/runs/${encodeURIComponent(runId)}/tail`, { cache: 'no-store' })
      .then(r => r.json())
      .then(j => {
        if(!j) return;
        const p = prettyStatusFromTail(j);
        setStatus(p.title, p.subtitle);
        // Update small log preview if available
        try {
          const lp = document.getElementById('logPane');
          const preview = document.getElementById('logPreview');
          if(lp && j.lines){
            lp.textContent = j.lines.split('\n').slice(-10).join('\n');
            // Do not auto-show logs; leave them hidden unless user toggles.
          }
        } catch(e){}
        // ETA/progress display removed — backend may still provide eta/progress but it's not shown here.
        if(j.done && !redirecting){
          redirecting = true;
          try { sessionStorage.setItem('retain-run-' + runId, '1'); } catch(_){}
          // give a brief success message before redirecting for UX
          setStatus('Completed', 'Redirecting to results...');
          setTimeout(()=>{ window.location.href = `/runs/${encodeURIComponent(runId)}/final`; }, 700);
        }
      })
      .catch(()=>{})
      .finally(()=>{ if(!redirecting) pollTimer = setTimeout(pollOnce, 1400); });
  }

  // Kick off polling
  pollOnce();
  // Copy button removed (logs hidden by default)
  // Open and clear log buttons removed
  // Toggle logs handler
  const toggleBtn = document.getElementById('toggleLogs');
  const logPreview = document.getElementById('logPreview');
  if(toggleBtn){
    toggleBtn.addEventListener('click', ()=>{
      if(!logPreview) return;
      const comp = window.getComputedStyle(logPreview).display;
      if(comp === 'none'){
        logPreview.style.display = 'flex';
        toggleBtn.textContent = 'Hide logs';
      } else {
        logPreview.style.display = 'none';
        toggleBtn.textContent = 'Show logs';
      }
      userToggledLogs = true;
    });
  }

  // Cancel run handler (assumes server supports POST /runs/<id>/cancel)
  const cancelBtn = document.getElementById('cancelRun');
  if(cancelBtn){
    cancelBtn.addEventListener('click', ()=>{
      if(!confirm('Cancel this run? This cannot be undone.')) return;
      cancelBtn.disabled = true;
      cancelBtn.textContent = 'Cancelling...';
      fetch(`/runs/${encodeURIComponent(runId)}/cancel`, { method: 'POST', headers: {'Content-Type':'application/json'} })
        .then(r => {
          if(r.ok) {
            // Stop further polling and inform the user, then redirect to main page
            redirecting = true;
            cancelBtn.textContent = 'Cancelled';
            setStatus('Cancelled', 'Run was cancelled');
            try { sessionStorage.setItem('retain-run-' + runId, '0'); } catch(_){ }
            // give a brief moment so the user sees the status change, then go to main page
            setTimeout(()=>{ window.location.href = '/'; }, 600);
          } else {
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'Cancel run';
            alert('Failed to cancel run');
          }
        })
        .catch(()=>{ cancelBtn.disabled = false; cancelBtn.textContent = 'Cancel run'; alert('Failed to cancel run'); });
    });
  }
})();
</script>
<!-- No cleanup on processing page: active runs may still be writing. Stale dirs are auto-cleaned by server. -->
{% endblock %}
